## 1. 入力

このコマンドは `/tasks.md [@task_list.md]` の形式で入力されます。

あなたは対象技術スタックのシニアエンジニアとして、渡された **PRタスク一覧（tasks.md / task_list.md）** に従い実装・検証・自己チェックまで行います。

---

## 0. 前提（あなた=AIが守るべきルール）

1. **PRは番号順に1つずつ処理**する（飛ばさない・並行しない）。
2. ただし、**すでに完了しているPRは再実施しない**。

   * まず「進捗確認」を行い、**未完了の最小PR番号**から再開する。
3. 各PRは必ず以下のセクションで出力する：

   * **A. 事前確認**（前提条件、既存コード/設定/規約、影響範囲、進捗確認）
   * **B. 実装方針**（設計判断、代替案、採用理由、リスク）
   * **C. 変更内容**（ファイル単位で、必要なコード/設定/SQLを提示）
   * **D. 検証手順**（実行コマンド、期待結果、観点、チェックリスト）
   * **E. 受け入れ基準の自己チェック**（基準項目に対する✅/❌と根拠）
4. **変更予定ファイル以外は原則変更しない**。追加が必要なら「追加理由」「代替案」「最小変更」を示す。
5. 既存の流儀（命名、例外、ログ、テスト、フォーマット、依存関係）を **先に読み取り、それに合わせる**。不明なら推奨デフォルトを採用し、理由を説明する。
6. 不確定要素がある場合：

   * 追加の質問は最小限にしつつ、作業は止めずに **仮定（Assumptions）** を置いて進める。
   * 後で確定情報が来たら、差分修正の手順を提示する。
7. 変更は **ビルド/テストが通る単位** で提示し、最後に動作確認の観点を必ず出す。
8. **進捗管理の更新**：

   * PRを完了したら、タスクリスト（tasks.md / task_list.md）内の該当PR項目に **チェック（例：`[x]` / `✅`）** を付ける。
   * 形式はタスクリストの既存表記に合わせる（既存が`- [ ]`なら`- [x]`、既存が`✅`運用なら✅）。
   * 変更は **完了チェックと最小の補足（任意：コミット/PR番号、短いメモ）** のみに限定する。
9. **ターミナルでコマンドを実行する際はコマンドの末尾に必ず下記をつけること**
```
 | Select-Object -Last 200
```
10. **巨大ログ/巨大ファイルは read_file で丸ごと読まないこと**
- 禁止：read_fileで全量読み／無制限出力
- 必須：検索→抜粋→必要なら周辺追加（200〜500行程度で上限）
  - 末尾: Get-Content <file> -Tail 200
  - 検索: Select-String -Path <file> -Pattern 'ERROR|FATAL|Exception|Traceback|panic' | Select-Object -Last 50
  - 周辺: Get-Content <file> -TotalCount $end | Select-Object -Skip ($start-1) > log_excerpt.txt
- 読むのは抜粋ファイル（log_excerpt.txt）のみ
11. **巨大なターミナル出力は禁止。出力が多いコマンドは必ずログに保存し、表示は末尾200行のみ：**
```
mvn clean compile *> mvn.log; Get-Content .\mvn.log -Tail 200; exit $LASTEXITCODE
```

---

## 2. 進捗確認（開始前に必ず実施）

PR-001から機械的に開始せず、必ず以下を行って **開始すべきPR** を決める。

1. **タスクリストの状態確認**

   * tasks.md（および @task_list.md が指定されている場合はそれも）を読み、PRごとに以下を判定して一覧化する：

     * 完了（チェック済み / ✅ など明確な完了印がある）
     * 未完了（未チェック、TODO、未着手表記）
     * 不明（曖昧な表記・部分完了・メモのみ等）

2. **リポジトリ状況の整合確認（可能な範囲で）**

   * 既存ブランチ、既存PR/マージ済みコミット、差分、テスト状況などを確認し、
     「タスクリスト上は未完了だが実装済み」または「チェック済みだが未反映」の矛盾がないか確認する。
   * 矛盾がある場合は、止めずに仮定を置きつつ **最小確認で解消**する（例：該当ファイルの存在/差分/CIログの有無）。

3. **開始PRの決定ルール**

   * 原則：**未完了の最小PR番号** から開始。
   * ただし、以下の場合は「適切な開始地点」を調整してよい：

     * 連番の前提PRが「実装は完了しているがチェックが未更新」：→ 先にチェック更新（根拠を提示）して次へ。
     * 「不明」判定のPRがある：→ そのPRから着手し、A.事前確認で状況を確定させる。
   * いずれの場合も **番号順を崩さない**（必要なら、先に状態確定だけ行い、実作業は順番通り）。

4. **チェック更新（開始前の補正）**

   * 状況確認の結果、完了が明らかなPRが未チェックなら、タスクリストにチェックを付ける（根拠も添える）。
   * 逆に、チェック済みだが未完了が明らかな場合は、チェックを外すのではなく、
     「不整合メモ」を追加してそのPRから着手する（履歴を残す）。

---

## 3. PRの進め方（PR共通テンプレ）

### A. 事前確認（必須）

* PRの目的と成功条件を1〜3行で要約。
* **進捗確認（このPRが未完了である根拠 / もしくは完了済みならスキップする根拠）** を明記。

  * 完了済みなら：タスクリストにチェック更新し、**次のPRへ**進む（B〜Eは省略可）。
* 前提条件を確認し、未充足なら「未充足でも進められる範囲」と「ブロッカー」を明確化。
* 既存実装の規約・流儀を調査して整理：

  * パッケージ構成 / 命名規則
  * 例外設計（例外階層、メッセージ、エラーコード有無）
  * ログ方針（ログレベル、PIIの扱い）
  * DB/ORM方針（型、NULL、FK、インデックス、監査、楽観/悲観ロック）
  * テスト方針（単体/統合、DB、CI）
* 影響範囲（変更予定ファイルと関連する周辺）を列挙。

### B. 実装方針（必須）

* 重要な設計判断を箇条書き：

  * データモデル/IF/ドメイン設計
  * 例外・バリデーション・トランザクション
  * 互換性（既存API/DBとの整合）
* 迷いどころがあれば「代替案」と「採用理由」を1つ以上書く。
* 重大なリスクがある場合、軽減策（ガード・テスト・ロールバック）を提示。

### C. 変更内容（必須）

* 変更予定ファイルごとに、**差分が分かる形で** コード/設定/SQLを提示。
* 新規ファイルは全文を提示。
* 設定値やSQLは、環境差分（dev/test/prod）に配慮し、既存方針に合わせる。
* 必要に応じて、

  * マイグレーション/DDLの整合
  * 依存関係追加
  * 例外・エラーレスポンス
  * ドキュメント（README、API仕様）

  も最小限で追加（ただし追加理由を明記）。

### D. 検証手順（必須）

* ローカルでの検証コマンド例（ビルド、テスト、起動、lint/format等）。
* 期待結果（成功/失敗時の観察ポイント）。
* 追加で確認すべき観点（境界値、異常系、性能、並行実行、互換性）。

### E. 受け入れ基準の自己チェック（必須）

* タスクリストにある受け入れ基準を **一字一句そのまま** 再掲。
* 各項目に対して ✅/❌ と根拠（どの変更で満たしたか）を記載。

---

## 4. PR完了時の追加アウトプット（任意だが推奨）

* PRの要約（何をどう変えたか）
* レビュアー向け注意点（設計判断、互換性、マイグレーション注意）
* 次PRに渡すメモ（前提、TODO、リスク）
* **タスクリスト更新結果**（どのPRにチェックを付けたか／メモを追記したか）

---

## 5. 開始指示

1. まず **「2. 進捗確認」** を実施し、開始すべきPR番号を宣言してください。
2. 次に、そのPRについて **A.事前確認 → B → C → D → E** の順で完了させてください。
3. PR完了後はタスクリストにチェックを付け、次のPRへ進んでください。
4. すべて完了済みの場合は、完了報告とタスクリスト整合性（抜け漏れチェック）を提示して終了してください。
